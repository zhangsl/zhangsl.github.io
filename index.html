<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Light&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Light's Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Light's Blog">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Light's Blog">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="Light&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/images/photo.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Light Zhang</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						
						<li>About</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/zhangsl" title="github">github</a>
					        
								<a class="rss" target="_blank" href="#" title="rss">rss</a>
					        
								<a class="mail" target="_blank" href="/zhang.shuliang@yeah.net" title="mail">mail</a>
					        
								<a class="linkedin" target="_blank" href="https://cn.linkedin.com/in/叔亮-张-a6a7b969" title="linkedin">linkedin</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/AOP/" style="font-size: 10px;">AOP</a> <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Binder/" style="font-size: 10px;">Binder</a> <a href="/tags/Design/" style="font-size: 10px;">Design</a> <a href="/tags/Event-Driven/" style="font-size: 10px;">Event Driven</a> <a href="/tags/Java/" style="font-size: 13.33px;">Java</a> <a href="/tags/Swift/" style="font-size: 10px;">Swift</a> <a href="/tags/mobile/" style="font-size: 10px;">mobile</a> <a href="/tags/translation/" style="font-size: 10px;">translation</a> <a href="/tags/性能优化/" style="font-size: 10px;">性能优化</a> <a href="/tags/杂思/" style="font-size: 16.67px;">杂思</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">Light is me!</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Light Zhang</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/images/photo.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">Light Zhang</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/zhangsl" title="github">github</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="mail" target="_blank" href="/zhang.shuliang@yeah.net" title="mail">mail</a>
			        
						<a class="linkedin" target="_blank" href="https://cn.linkedin.com/in/叔亮-张-a6a7b969" title="linkedin">linkedin</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-TraceViewInAndroidStudio" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/17/TraceViewInAndroidStudio/" class="article-date">
  	<time datetime="2016-06-17T13:43:37.000Z" itemprop="datePublished">2016-06-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/17/TraceViewInAndroidStudio/">天猫Android性能优化1—AndroidStudio内置的Traceview视图</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Traceview是分析Android性能不可或缺的利器。目前一般是用DDMS或者ADT里面的traceview工具来查看的。哪怕是<a href="https://developer.android.com/studio/profile/traceview.html" target="_blank" rel="external">AndroidStudio官网</a>也是如此推荐。<br>一个偶然的机会，发现AndroidStudio本身可以查看Traceview文件，而且更直观。<br><img src="http://img4.tbcdn.cn/L1/461/1/6aae7c26e102a37b9bbca6dd166f50253a239e35" alt="screenshot"><br>它分成三部分：顶部工具栏，中间的“Flamechart”显示执行过程及调用堆栈，底部的表格显示该线程中各个函数的执行时间与调用次数。</p>
<h3 id="顶部工具栏"><a href="#顶部工具栏" class="headerlink" title="顶部工具栏"></a>顶部工具栏</h3><p><img src="http://img4.tbcdn.cn/L1/461/1/97cbf2465fc6278a0faca8b3e1cf61a88a0ceade" alt="screenshot"></p>
<ol>
<li>Thread: 选择你要查看哪个线程的执行情况，默认是主线程的。</li>
<li>x-axis: Wall Clock Time就是Real Time，该函数开始执行和结束执行之间的时间差。Thread Time就是CPU Time，真实消耗CPU的时间。</li>
<li>Color by inclusive time: 在中间的Flamechart中，默认是根据exclusive time着色的。如果根据inclusive time着色，函数执行时间越长，颜色越深，所以顶层的函数颜色是最深的。</li>
<li>Zoom fit：缩放用的，用鼠标滚轮也能实现。</li>
<li>Find：查找某个函数。</li>
</ol>
<h3 id="中间的Flamechart"><a href="#中间的Flamechart" class="headerlink" title="中间的Flamechart"></a>中间的Flamechart</h3><p><img src="http://img2.tbcdn.cn/L1/461/1/228aaa5cec6ac9dc442a1c7012fb156a3abb5bdd" alt="screenshot"><br>横向表示时间线上函数的执行情况，长度越长，表示函数的执行时间越长。纵向表示调用堆栈。<br>以上图为例。第一行只有一个main()函数，它是函数调用堆栈的root，我们的trace一直在main()函数的执行时间内。第二行比较明显的有TMHomePageView()和TMHomePageActivity.init()函数，表示在我们trace期间，main()调用了这两个函数消耗了大部分时间。其中以TMHomePageActivity.init()最为耗时。第三行则显示了TMHomePageView()和TMHomePageActivity.init()调用的函数，以此类推。</p>
<h3 id="底部表格"><a href="#底部表格" class="headerlink" title="底部表格"></a>底部表格</h3><p><img src="http://img1.tbcdn.cn/L1/461/1/87183fa55cd82de664094d755d5240e8218499d8" alt="screenshot"></p>
<ol>
<li>Name: 该列表示该线程中所执行的函数。</li>
<li>Invocation Count: 该函数的总调用次数，包括递归调用。</li>
<li>Inclusive Time：即Real Time，函数开始执行到执行结束的时间差。</li>
<li>Exclusive Time: 即CPU Time, 函数正在消耗CPU的时间。</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>该视图的优点是直观，容易上手。如果你只关注某个线程上的函数执行情况，用该工具是极好的。</p>
<h3 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h3><p>Traceview in Android Studio官方文档：<a href="http://tools.android.com/tips/traceview" target="_blank" rel="external">http://tools.android.com/tips/traceview</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/性能优化/">性能优化</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-遗书（2016-6-11）" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/11/遗书（2016-6-11）/" class="article-date">
  	<time datetime="2016-06-11T03:38:23.000Z" itemprop="datePublished">2016-06-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/11/遗书（2016-6-11）/">遗书（2016.6.11）</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>听说在西方，有些人每年都会更新自己的遗书，我觉得这是一个很好的习惯，因为无论老少，都要面对生死，因此无须避讳。虽然我正当青春，我想我同样需要这样一份书，倘若突发变故，也可以向家人朋友表明我的心意。<br>倘若我偶然离世，与我自己而言，是好得无比的。我真信仰我主耶稣基督，真知道他的拯救是可靠的，他所预备在天上的房屋是荣耀的，我也要在他里面享受永远的生命。</p>
<p>但是对于家人而言，我想会非常难过吧。至亲之人离去总是让人无法接受的，更何况是正直青年的独生子，承载所有希望的。这样的失去对于任何人都是难以忍受。面对这样的失去，如果再有一些恶意的人，在背后冷言冷语地嘲讽，就更加绝望了。但我真心的希望你们知道，神的美意好得无比，超过我们所想的。</p>
<p><strong>请不要为亲人离去而忧伤。</strong>我们若在基督里，就不是永远地失去，只是暂时分别。从《圣经》中我们知道人是灵魂活着的，这地上用尘土做的身体，是我们暂时寄居的帐篷而已。并且不论何人，将来都要复活，只是不信耶稣的人，复活要为自己的罪受审判；而信耶稣的人，因为耶稣为我们的罪受审判，故此可以承受永远荣耀的生命。这一切并不是那么虚无缥缈。耶稣曾经真实地在地上，这是《圣经》以及其他史书明确记载的。我们也知道他真实地被钉死在十字架上，虽然本身并无什么罪。而我们也承认在我们里面的罪。因着耶稣钉十字架，我们就知道我们真是罪人，神真是公义恨恶罪恶的。神无法容忍罪恶，必要审判，甚至不惜让自己的独生爱子钉十字架，庶民犯罪，让王子代赎。从耶稣基督钉十字架，我们也真知道神真爱我们。明明是我们犯罪，神却让他的独生爱子替我们受审判，还有什么爱比这更大呢？从这里我们也看到，对于不信的人，将来要受的审判是何等可怕，神即不顾让爱子钉死来接受我们罪的审判。那些离弃耶稣救赎，自己承受审判将是何等可怕呢？从这里我们也看到，对于信的人，我们将来有荣耀的身份。因为神是用自己独生爱子舍命赎我们回来的，是极其尊贵的。所以我们的将来是真实的，请不要忧伤，悔改仰望主，主必快来。</p>
<p><strong>请不要因为“独苗”夭折而失去所有盼望。</strong>对于不信的世人，年老的时候会把所有的希望寄托在自己的后裔上。我还没有到那个年纪，因此无法准确地体会这种心情。我想他们可能是意识到自己身体衰残，生命有限的事实，因此会把后裔看作自己生命的延续，自然而然把希望寄托在其上。正如愚公所说“子子孙孙，无穷尽也。”但是对于信的人来说，我们每个人都是独自面对神。因此我们的盼望不可能在我们的后裔身上，因为他也要独自面对神，要独自跟随主。相反，我们的盼望必然是在与神。若我们把自己的后裔当成自己的盼望，则不论他是否长寿，你都要失望的，因为他不是为你而活，他是为神而活。并且他作为人，本质就意味着是有限的，是有罪的，是靠不住的。神才是可靠的。如上面所说，基督耶稣是确实的，他的拯救也是确实的。他是可靠的。</p>
<p><strong>请不要为恶人的言语而忧伤，为他们的无知而忧伤吧。</strong>因为他们不知道自己所说的是什么，他们更不知道自己要面临的审判是何等可怕。为他们而忧伤吧，愿他们能从自己的罪中悔改。</p>
<p>我亲爱的家人，亲爱的朋友，愿你们喜乐！</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/杂思/">杂思</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-杂思（2016-5-29-2016-6-5）" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/29/杂思（2016-5-29-2016-6-5）/" class="article-date">
  	<time datetime="2016-05-29T07:34:46.000Z" itemprop="datePublished">2016-05-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/29/杂思（2016-5-29-2016-6-5）/">杂思（2016.5.29~2016.6.5）</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="一"><a href="#一" class="headerlink" title="一"></a>一</h3><p>我周围的人影响着我，我也影响着周围的人。<br>我应该跟追求公义正直的人结交，远离沉溺罪中的人。这种观点历来都是很被认可的。但我去做的时候，就觉得自己很虚伪，因为好像我自己很纯洁，跟罪恶的人结交会污秽我。实际上，我心里清楚，我也不是什么好人啊！所以罪人，嫌弃另外一个罪人太罪恶，难道不虚伪吗？<br>但是我现在发现，正是因为我是罪人，非常擅长犯罪，所以我非常需要和追求公义圣洁的人结交，给我带来正面的影响，从而可以远离罪恶。因为我是罪人，非常容易被引诱，所以需要远离沉溺罪中的人，免得自己被引诱去。<br>反过来，如果我真的洁白无瑕，那我应该专门去跟沉溺罪中的人结交，好让他们可以被影响地好一点。可惜我不是。这世上只有一个这样的人，他叫耶稣，专做罪人的朋友，不但如此，更为罪人死，替罪人还罪债。</p>
<h3 id="二"><a href="#二" class="headerlink" title="二"></a>二</h3><p>有时候我们会不好意思承认自己的无知，特别是当自己被冠以“XXX专家”等头衔后。好像随着我们年龄增长，阅历增长，级别增长就应该知道所有事情，不知道就不好意思。其实人怎么肯能知道所有事情呢？“XXX专家”就得什么都懂，这种预设是不诚实的。我想区分智者和愚昧，主要不是懂得的多少，而是面对同一件未知之事所表现出的不同态度，以及所采取的努力。承认自己无知，并认真寻求的人是有盼望的，因为他终必寻得真知。而不好意思承认的，那就一直空有头衔吧。</p>
<h3 id="三"><a href="#三" class="headerlink" title="三"></a>三</h3><p>权威来自何处？<br>带团队的人，都会面临一个问题，如何让其他人来跟随呢？见到很多leader带队伍，下面的人懒懒散散，一点都不积极。等到他自己被别人带，他也懒懒散散，不愿意服从。我想权威来自何处呢？在《孙子兵法》中有类似的故事，说孙子为了显示其大将之才，将一帮宫女训练成服从的士兵。孙子的做法总的有两步，第一步是发布明确的指令，第二步是对违令者严厉的惩罚。通过明确的指令让大家知道该做什么，不该做什么？然后通过严厉的刑罚让大家服从。所以，权威从酷刑威吓而来吗？古代中国大体如此吧，成语“杀鸡儆猴”就是这种思想吧。<br>所以权威从武力而来？从上面看好像是，但其实又不是，当武力的施行违背人良心的原则，就会被推翻，例如秦的通知不可谓不武，却速速被推翻了。<br>究竟权威来自何处，凭什么让其他人来跟从。现代似乎不再奉行武力这一套，更多是柔性的，通过一些事情吸引你，让你来跟随。或者是利益的分配，或者是一个很美的故事。但权威就是这么来的吗？如果这样下去，越能忽悠，就越有出息？似乎也不是。<br>《圣经》说“没有权柄不是出于神的。”因此人没有权柄说，“你来跟从我”，人只能帮助人去跟随神。我想无论是用武力，或者用巧计让别人来跟从个人的，都是盗贼，都是行诡诈破坏之事的。<br>因此对于哪怕对于没有信仰的leader而言，其核心要素是公平，正直，行使符合人的良心。同时又要敢于面对人心的罪恶与丑恶，不论是自己的或是他人的。</p>
<h3 id="四"><a href="#四" class="headerlink" title="四"></a>四</h3><p>高贵的读书，踏实的写作。<br>曾经觉得读书是一种消遣，可以看看一些好玩的故事，了解一些小知识用于茶余饭后闲谈。后来听齐宏伟先生说，读书是一件高贵的事，因为有人为了你能读书付出了代价。更后来读一些经典，看到的是前人对生命的尊重，对真理的认真寻求。至此，我不再随便阅读，不再读那些看似搞笑好玩，实则没有生命的东西。在读那些经典作品的同时，也表明我自己愿意踏上同样的寻求的道路。<br>曾觉得那些写书的人很厉害，也想自己写本书显摆显摆。但是同样基于上面认知的转变，我发现书不过是他们观察，寻求，思考的结果而已。写出伟大作品的人，从来没有一个是为了写书而写书。而是孜孜不倦需求真理，然后自然产出不朽名篇。因此放弃原来那些幼稚浮躁的想法吧，同样追随先贤的脚踪，尊重生命，认真而踏实寻求真理。</p>
<h3 id="五"><a href="#五" class="headerlink" title="五"></a>五</h3><p>所谓家人，在有养育之恩的同时，会不可避免的带给你不好的影响；在给你照顾安慰的同时，也不可避免的有让你难以忍受之处。但不论如何都是家人，可以不喜欢，甚至反感，但必须要爱。与此同时，我们自己也同样是罪人。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/杂思/">杂思</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-BinderStudy" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/18/BinderStudy/" class="article-date">
  	<time datetime="2016-05-18T11:49:33.000Z" itemprop="datePublished">2016-05-18</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/18/BinderStudy/">Android Binder学习趣事</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>看Android源码无论如何绕不开Binder，因此我一直对Binder的实现机制有浓厚的兴趣。无奈本人功力不够，所以对此一直没有清晰的认识。看了网上一些分析Binder的文章，基本都是源码分析，我觉得对于Binder这样一种比较复杂的框架，最好不要一开始就进入到源码这么细节的层面，很容易找不到北。我觉得应该先撇开代码，有原理性的介绍，再根据个人需要深入代码去分析。因为没有找到合适的文章，所以我就想自己来探究，自己来写，我主要想解决以下几个问题：</p>
<ol>
<li>Binder的历史？</li>
<li>Binder和Linux原有的IPC有什么区别，为什么一定要用Binder？</li>
<li>Binder整体的设计是怎样的？</li>
<li>Binder的跨进程数据传输是怎么实现的？</li>
</ol>
<p>但是，正当我准备自己动手探究时，却找到一篇很不错的文章<a href="http://www.programering.com/a/MjMyMDMwATQ.html" target="_blank" rel="external">Android Binder design and implementation design</a>，一下子把我的问题都回答了，开心，又有点失落。这真是一篇高质量的文章，我想我可以把它翻译成中文，跟大家分享。然而紧接着在里面一个例子中看到”Zhang San”。心里惊呼“难道原文是中文？”。还真找到了，原文在CSDN上<a href="http://blog.csdn.net/universus/article/details/6211589" target="_blank" rel="external">Android Bander设计与实现 - 设计篇</a>。这下只有为国人感到自豪了。这篇文章清晰地阐述了Binder的设计实现机制，清晰易懂。</p>
<p>整体的设计已经了然于胸，就可以自己去看代码，亲自触摸里面的实现细节。网上有不少源码分析的文章，最有名的要数<a href="http://blog.csdn.net/luoshengyang/article/details/6618363" target="_blank" rel="external">老罗</a>的。但是我觉得源码就像一个丰富的宝库，源码分析应该是带着问题，有目的地去分析，不然只会被别人牵着鼻子走，或者迷失其中。就像老罗在系统地分析Android源码前也是看了很多书（见<a href="http://blog.csdn.net/luoshengyang/article/details/8923485" target="_blank" rel="external">那两年炼就的Android内功修养</a>）。</p>
<p>除了阅读源码，了解Binder的实现细节，我还想了解Linux原有的IPC机制，例如管道，System V IPC，socket是如何设计的，其设计思想和出发点各有什么不同？此处先留着问题，后面再探究总结。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Binder/">Binder</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-杂思（2016-5-9-2016-5-14）" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/09/杂思（2016-5-9-2016-5-14）/" class="article-date">
  	<time datetime="2016-05-09T02:29:51.000Z" itemprop="datePublished">2016-05-09</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/09/杂思（2016-5-9-2016-5-14）/">杂思（2016.5.9~2016.5.14）</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="一"><a href="#一" class="headerlink" title="一"></a>一</h3><p>证明别人是错的，不能证明自己就是对的。<br>一个人拼命证明1+1不等于3，1+1不等于4，然后抛出1+1=5的结论，真是狡猾至极！通过猛烈攻击已知错误的结论，来增加自己的可信度，好像自己是正确的代表，结果自己提出的是另外一种错误结论，这样做实质是为了让自己的观点逃避被别人批判，实质是一种欺骗。<br>所以诚实的辩论应该首先抛出自己明确而系统的观点，让自己的观点可以被别人批判（在这之前应该首先有很多遍自我批判了）。再此基础上，再论证与其他观点的区别。<br>这样的诚实其实是必须的，从利己的角度来说，没有一个人可以确保自己掌握了真理，他人的批判可以帮助自己发现自己认知中的瑕疵，从而有改正的机会。从利他的角度来说，谨慎的观点可以尽量避免将他人引入歧途。</p>
<h3 id="二"><a href="#二" class="headerlink" title="二"></a>二</h3><p>我觉得“怎么做”比“做什么”更加重要。<br>因为能“做什么”取决于很多因素，有客观的环境，有个人的意愿，有各样的机会与巧合。但是“怎么做”则几乎完全取决于自己。<br>从这个角度来讲，我们通常所谓的“梦想”其实存在一种误导。我们通常的“梦想”一般是通过完成一件具体的事情来体现自己的价值，让自己感到满足。但是如上分析，能否做某件具体事情，并不是我们个人能掌控的。所以有“梦想”固然好，但是不要成为他的奴隶。时机允许，完成心愿甚好；若时机不允许，亦无需强求。<br>但是怎么面对我们所处的环境，怎么做很重要，不但因为这是我们能做的，而且因为这反映了我们所信的，反映了我们是什么样的人。</p>
<h3 id="三"><a href="#三" class="headerlink" title="三"></a>三</h3><p>今天，坐在办公室感到楼摇动了一下，头顶上的天猫战旗因震动而摇晃着。隔海相望的台湾地震了！<br>今天，是5月12日，也正好是汶川地震的纪念日。听王怡牧师讲，在汶川地震中，他突然发现原来我们所谓的不动产也可以在顷刻间灰飞烟灭。今天再一次的地震，是在警醒我们这世界要过去，我们要悔改。是的，甚愿我们此刻悔改。从对金钱的无度贪婪中悔改，从对弱者的欺凌和冷漠中悔改，从自立为王的狂傲中悔改。愿我们停止嬉笑，为自己的罪哀哭。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/杂思/">杂思</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Android-View-Scroller问答" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/07/Android-View-Scroller问答/" class="article-date">
  	<time datetime="2016-05-07T08:04:08.000Z" itemprop="datePublished">2016-05-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/07/Android-View-Scroller问答/">Android View Scroller问答</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>android中的scroll一般是调用View.scrollTo()函数实现的，另外有一个View.scrollBy()其实现也是View.scrollTo()。关于View.scrollTo()，下面有一些问题来探究一下，本文所查看的代码是android4.2.2的源代码。</p>
<ul>
<li><p><strong>问：View.scrollTo()的原理是什么？</strong><br>答：在android.view.View.java中有两个变量mScrollX和mScrollY，两个变量的定义如下：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    </span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * The offset, in pixels, by which the content of this view is scrolled</span><br><span class="line"> * horizontally.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">int</span> mScrollX;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * The offset, in pixels, by which the content of this view is scrolled</span><br><span class="line"> * vertically.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">int</span> mScrollY;</span><br></pre></td></tr></table></figure>
<p>在View的绘制过程中，会根据这两个值对里面的内容进行偏移。View.draw()中的代码片段如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="keyword">int</span> left = mScrollX + paddingLeft;</span><br><span class="line"><span class="keyword">int</span> right = left + mRight - mLeft - mPaddingRight - paddingLeft;</span><br><span class="line"><span class="keyword">int</span> top = mScrollY + getFadeTop(offsetRequired);</span><br><span class="line"><span class="keyword">int</span> bottom = top + getFadeHeight(offsetRequired);</span><br></pre></td></tr></table></figure>
<p>在View.scrollTo()的作用就是就是改变这两个变量，从而引起View的content位置发生变化。</p>
</li>
<li><strong>问：Scroll是否引起Layout的改变？</strong><br>答：Scroll只是改变View.mScrollx和View.mScrollY，并且在draw()函数中，根据这两个偏移量进行绘制。所以只是影响draw()，不会引起Layout的改变。</li>
<li><p><strong>问：如果scroll只是在绘制的时候进行偏移，那么对touch事件的派发是否产生影响，View事件的响应是在scroll前的位置还是scroll后的位置？</strong><br>答：事件的分派是在ViewGroup.dispatchTouchEvent()中，查看源码，发现在寻找响应事件的子View时，会算上mScrollX和mScrollY的偏移。所以scroll是会对事件派发产生影响的。View事件的响应是在scroll后的位置。关键代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">protected boolean isTransformedTouchPointInView(float x, float y, View child,</span><br><span class="line">        PointF outLocalPoint) &#123;</span><br><span class="line">    float localX = x + mScrollX - child.mLeft;</span><br><span class="line">    float localY = y + mScrollY - child.mTop;</span><br><span class="line">    if (! child.hasIdentityMatrix() &amp;&amp; mAttachInfo != null) &#123;</span><br><span class="line">        final float[] localXY = mAttachInfo.mTmpTransformLocation;</span><br><span class="line">        localXY[0] = localX;</span><br><span class="line">        localXY[1] = localY;</span><br><span class="line">        child.getInverseMatrix().mapPoints(localXY);</span><br><span class="line">        localX = localXY[0];</span><br><span class="line">        localY = localXY[1];</span><br><span class="line">    &#125;</span><br><span class="line">    final boolean isInView = child.pointInView(localX, localY);</span><br><span class="line">    if (isInView &amp;&amp; outLocalPoint != null) &#123;</span><br><span class="line">        outLocalPoint.set(localX, localY);</span><br><span class="line">    &#125;</span><br><span class="line">    return isInView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>问：<strong>Scroller的作用是什么？</strong><br>答：Scroller的作用是帮助Scroll更加顺滑的。如果我们不是想在一段时间内，有A点顺滑的scroll到B点。这样我们就要计算每次draw应该偏移多少，才能达到顺滑的效果。Scroller就是用来帮助计算的。具体的计算方式是在Scroller.computeScrollOffset()函数中。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">computeScrollOffset</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (mFinished) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> timePassed = (<span class="keyword">int</span>)(AnimationUtils.currentAnimationTimeMillis() - mStartTime);</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> (timePassed &lt; mDuration) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (mMode) &#123;</span><br><span class="line">    <span class="keyword">case</span> SCROLL_MODE:</span><br><span class="line">        <span class="keyword">float</span> x = timePassed * mDurationReciprocal;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (mInterpolator == <span class="keyword">null</span>)</span><br><span class="line">            x = viscousFluid(x); </span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            x = mInterpolator.getInterpolation(x);</span><br><span class="line">    </span><br><span class="line">        mCurrX = mStartX + Math.round(x * mDeltaX);</span><br><span class="line">        mCurrY = mStartY + Math.round(x * mDeltaY);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> FLING_MODE:</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">float</span> t = (<span class="keyword">float</span>) timePassed / mDuration;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> index = (<span class="keyword">int</span>) (NB_SAMPLES * t);</span><br><span class="line">        <span class="keyword">float</span> distanceCoef = <span class="number">1</span>.f;</span><br><span class="line">        <span class="keyword">float</span> velocityCoef = <span class="number">0</span>.f;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; NB_SAMPLES) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">float</span> t_inf = (<span class="keyword">float</span>) index / NB_SAMPLES;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">float</span> t_sup = (<span class="keyword">float</span>) (index + <span class="number">1</span>) / NB_SAMPLES;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">float</span> d_inf = SPLINE_POSITION[index];</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">float</span> d_sup = SPLINE_POSITION[index + <span class="number">1</span>];</span><br><span class="line">            velocityCoef = (d_sup - d_inf) / (t_sup - t_inf);</span><br><span class="line">            distanceCoef = d_inf + (t - t_inf) * velocityCoef;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mCurrVelocity = velocityCoef * mDistance / mDuration * <span class="number">1000.0f</span>;</span><br><span class="line">        </span><br><span class="line">        mCurrX = mStartX + Math.round(distanceCoef * (mFinalX - mStartX));</span><br><span class="line">        <span class="comment">// Pin to mMinX &lt;= mCurrX &lt;= mMaxX</span></span><br><span class="line">        mCurrX = Math.min(mCurrX, mMaxX);</span><br><span class="line">        mCurrX = Math.max(mCurrX, mMinX);</span><br><span class="line">        </span><br><span class="line">        mCurrY = mStartY + Math.round(distanceCoef * (mFinalY - mStartY));</span><br><span class="line">        <span class="comment">// Pin to mMinY &lt;= mCurrY &lt;= mMaxY</span></span><br><span class="line">        mCurrY = Math.min(mCurrY, mMaxY);</span><br><span class="line">        mCurrY = Math.max(mCurrY, mMinY);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mCurrX == mFinalX &amp;&amp; mCurrY == mFinalY) &#123;</span><br><span class="line">            mFinished = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        mCurrX = mFinalX;</span><br><span class="line">        mCurrY = mFinalY;</span><br><span class="line">        mFinished = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>问：Scroll和ValueAnimator的区别是什么？</strong><br>答：ValueAnimator的本质是在一段时间内，按照一定的规律去改变一个值。而scroll就是改变mScrollX和mScrollY的值。所以理论上也可以用ValueAnimator来改变mScrollX和mScrollY，从而达到scroll的目的。</p>
</li>
<li><strong>问：Scroll和Animation的区别是什么？</strong><br>答：animation也是通过在draw函数里面实现的，但是animation只是改变了绘制的位置，并没有影响到事件的响应。所以当一个View从A点通过Animation动画移动到B点，View的事件继续在A点才能响应。</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Android-System-gc-注意点" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/07/Android-System-gc-注意点/" class="article-date">
  	<time datetime="2016-05-07T08:03:21.000Z" itemprop="datePublished">2016-05-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/07/Android-System-gc-注意点/">Android System.gc()注意点</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在看<a href="https://github.com/square/leakcanary" target="_blank" rel="external">square Leakcanary</a>源码时，发现这样一段话：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GcTrigger DEFAULT = <span class="keyword">new</span> GcTrigger() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runGc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// Code taken from AOSP FinalizationTest:</span></span><br><span class="line">      <span class="comment">// https://android.googlesource.com/platform/libcore/+/master/support/src/test/java/libcore/</span></span><br><span class="line">      <span class="comment">// java/lang/ref/FinalizationTester.java</span></span><br><span class="line">      <span class="comment">// System.gc() does not garbage collect every time. Runtime.gc() is</span></span><br><span class="line">      <span class="comment">// more likely to perfom a gc.</span></span><br><span class="line">      Runtime.getRuntime().gc();</span><br><span class="line">      enqueueReferences();</span><br><span class="line">      System.runFinalization(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="跟进"><a href="#跟进" class="headerlink" title="跟进"></a>跟进</h2><p>到底有什么不一样呢？<br>我看了手头的4.2.2以及openjdk的源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">gc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Runtime.getRuntime().gc();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>System.gc()的实现就是调用Runtime.getRuntime().gc()，所以两者是等价的。所以这里是否是作者多虑了呢？我又看了一下5.0的源码，果然不一样了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Whether or not we need to do a GC before running the finalizers.</span><br><span class="line"> */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> runGC;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   * If we just ran finalization, we might want to do a GC to free the finalized objects.</span><br><span class="line">   * This lets us do gc/runFinlization/gc sequences but prevents back to back System.gc().</span><br><span class="line">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> justRanFinalization;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line">    * Provides a hint to the VM that it would be useful to attempt</span><br><span class="line">    * to perform any outstanding object finalization.</span><br><span class="line">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runFinalization</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> shouldRunGC;</span><br><span class="line">        <span class="keyword">synchronized</span>(lock) &#123;</span><br><span class="line">            shouldRunGC = runGC;</span><br><span class="line">            runGC = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (shouldRunGC) &#123;</span><br><span class="line">            Runtime.getRuntime().gc();</span><br><span class="line">        &#125;</span><br><span class="line">        Runtime.getRuntime().runFinalization();</span><br><span class="line">        <span class="keyword">synchronized</span>(lock) &#123;</span><br><span class="line">            justRanFinalization = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span><br><span class="line">   * Indicates to the VM that it would be a good time to run the</span><br><span class="line">   * garbage collector. Note that this is a hint only. There is no guarantee</span><br><span class="line">   * that the garbage collector will actually be run.</span><br><span class="line">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">gc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">boolean</span> shouldRunGC;</span><br><span class="line">      <span class="keyword">synchronized</span>(lock) &#123;</span><br><span class="line">          shouldRunGC = justRanFinalization;</span><br><span class="line">          <span class="keyword">if</span> (shouldRunGC) &#123;</span><br><span class="line">              justRanFinalization = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            runGC = <span class="keyword">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="keyword">if</span> (shouldRunGC) &#123;</span><br><span class="line">          Runtime.getRuntime().gc();</span><br><span class="line">   &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样改之后，单纯调用System.gc()是不会触发Runtime.getRuntime().gc()的。但是会把这次尝试纪录下来，等到下次调用System.runFinalization()时，会先执行这个Runtime.getRuntime().gc()。<br>这样改后的影响至少有两点：<br>1.单纯调用System.gc()是不会触发Runtime.getRuntime().gc()的，直到调用了System.runFinalization()<br>2.System.gc() -&gt; System.gc() -&gt; … -&gt; System.gc()  -&gt;System.runFinalization()，最终只会调用一次Runtime.getRuntime().gc()</p>
<p>为什么要这样改呢？<br>找到了这个<a href="https://android.googlesource.com/platform/libcore/+/930e26f0f59c0ce1020524269c82492f3c4ea722%5E%21/luni/src/main/java/java/lang/System.java" target="_blank" rel="external">commit</a>，是这样描述的:</p>
<blockquote>
<p>Avoid running Runtime.gc() until we need to run finalization.</p>
<p>This prevents excessive explicit GC which are called from apps to get<br>good GC behavior on Dalvik. Calling System.gc() does not help on ART<br>since GC for alloc is much rarer.</p>
<p>If running finalizers is requested following a System.gc we remember<br>that a GC was requested and perform it ahead of finalization.</p>
<p>Bug: 12004934</p>
</blockquote>
<p>从这里可以得到两点信息：<br>1.首先这是为了修复一个bug 12004934，具体什么bug找不到了<br>2.其次在art模式下，直接调用gc的效果不大。至于为什么，还没有深入进去了解，这是ART相关的另外一个专题了，后面再详细跟进。</p>
<p>回到开头，leakcanary的作者在这里直接用了Runtime.getRuntime().gc()的确是有理由的，但是这应该不是最好的方式，因为从这个提交的描述来看，连续调用Runtime.getRuntime().gc()可能存在bug。修改后的模式是gc / finalization / gc，虽然leakcanary这里的使用不会有问题。但是我觉得我们自己使用的话，用System.gc() 配合 System.runFinalization()会比较好。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-如何学习设计" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/07/如何学习设计/" class="article-date">
  	<time datetime="2016-05-07T08:02:43.000Z" itemprop="datePublished">2016-05-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/07/如何学习设计/">如何学习设计</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>从GOF的”Design Pattern”中的观点，可以看到模式的有两个要素：</p>
<blockquote>
<p>1.反复出现的问题；<br>2.针对该问题的解决方案。</p>
</blockquote>
<p>所以从这里看出学习设计模式，首先是积累问题，对问题进行归纳，分类，对比。其次是积累对问题的解决方案。<br>然而大部分人初学者都缺乏经验，学习设计模式是一个很好的思路。在看书的时候，在看书时，我觉得不是死记概念，而是可以不停地问自己这些问题：</p>
<ol>
<li>这个模式是针对什么问题提出的？</li>
<li>为什么要这么做，而不那么做？</li>
<li>这样做有什么优势和劣势？</li>
<li>和其他类似的模式区别在哪里？</li>
</ol>
<p>在自己设计的时候，也这样问自己：</p>
<ol>
<li>我碰到什么问题，问题的本质与核心是什么？</li>
<li>我可以用哪些方案解决问题？</li>
<li>为什么用这些方案？各自有什么优劣势？</li>
<li>最终选择哪个方案比较好？</li>
</ol>
<p>其实这是用批判性思维做设计，我觉得这样可以相对比较深入全面的了解问题，审视自己的设计。做到有理有据，心中有谱，和别人讨论时也能够给别人带去假设性的思想。同时在这个过程中，也加深自己对设计的理解。<br>我不太提倡死板套用设计模式，任何模式都是用来解决特定问题的，如果被套住，就无法深入了解其中的思想，也就不能真正做好设计，不能在已有设计上做提高。<br>同时我也不认同不用看设计模式，只要遵守设计原则就好了。我觉得看设计模式是一个很好的学习机会，是前人的总结，不能浪费。<br>另外看到一篇讲如何设计API的文章，觉得挺好，贴出来分享：<a href="http://www.infoq.com/articles/doodles-to-delivery" target="_blank" rel="external">An API Design Process</a><br>他主要讲了API设计的流程和一些注意点。但是其中我觉得他讲到一点给我挺大启发。他说设计API最重要的首先自己要清楚为什么要设计这个API，有明确的意识，是良好设计的前提。其次是设计过程中会碰到一系列决定，要做出明智的决定，当做出的决定都是明智的，这个API就坏不到哪里去。<strong>而做出明智的决定，你得先做过不好的决定，从中吸取教训，能以辨别好坏。</strong><br>这一点给我的鼓励是让我可以正面自己做过的糟糕决定，明白这也是学习的宝贵机会。不光是自己的，看到别人做的糟糕的设计，也是宝贵的学习机会，要去想为什么他的设计会失败？从中就可以吸取教训。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Design/">Design</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Less-mobile-more-everything－重新思考Mobile" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/07/Less-mobile-more-everything－重新思考Mobile/" class="article-date">
  	<time datetime="2016-05-07T08:01:24.000Z" itemprop="datePublished">2016-05-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/07/Less-mobile-more-everything－重新思考Mobile/">Less mobile, more everything－重新思考Mobile</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在google developer上看到一篇文章<a href="https://medium.com/google-developers/less-mobile-more-everything-75e0bdcd7c1a" target="_blank" rel="external">《Less mobile, more everything》</a>。<br>这篇文章写的有点偏激，因此会比较有争议，但有些观点挺有价值，翻译出来跟大家分享。</p>
<h3 id="译文"><a href="#译文" class="headerlink" title="译文"></a>译文</h3><blockquote>
<p>我将要讲一些比较有争议性的观点。<br>我不喜欢用我的手机。<br>我相信手机在很多场景中存在劣势，因为它的屏幕尺寸（太小），历史环境，尤其是（不方便）的输入方式。它们非常善于消费，并且独自消费。我会继续用我的电脑完成我的工作。<br>当然不是所有人都像我这样，如果你碰巧是一个流浪汉，你会倾向继续把所有东西往手机上迁移。如果你碰巧不是一个流浪汉，我奉劝你三思。<br>个人电脑用着很爽。它有无限使用的电源；它有更好的输入方式；它有着一个巨大的屏幕，你可以同时展示很多内容，也可以更加高效进行多任务；它们，毫无疑问，是最好的，最高效的工作计算机。<br>为什么我们如此努力地把功能都往手机上面搬，而不是把它只作为众多选择之一？为什么不能让台式机，笔记本，平板电脑，手机和智能手表和谐共处？为什么我们在都没有想清楚什么是手机的情况下，就如此狭隘地认为手机会成为下一个“big thing”？手机真的代表最合适的设备吗？平板怎么样呢？<br>如果你有一个花费不菲的家可回，你会如何使用你的家，让自己感觉最舒服？你的家是一个可以很棒地浏览网页，写随笔，写开源代码的地方。它是一个安全，稳定，舒适并且通常是一个安静的地方。你买iPad不是为了拿它去公园，你通常坐在床上用它浏览新闻（iPad的主要使用场景是在家里）。在晚上的时候，你不会想要一个小屏幕的设备来看新闻。 <strong>你需要一个轻薄，大屏，无线联网，电池续航持久的设备在你的卧室中。只是你没有注意到这一点</strong> 。<br>在你大叫（反对我）之前，我也为手机感到惊叹。我有两台智能手机，数台平板。我全心拥抱手机变革，并且努力的工作（我在Google工作）让手机浏览网页的体验更好。见鬼，我自己却一直是在用iPad。我用它因为它能更好地替代手机。<br>在计算机世界，今天我们正停止多样化的尝试，把大部分的资源都投入到手机（包括可穿戴设备）。我们现在做的事不是让我们更快地发展，而是在禁锢我们的视野。<br>我挑战你发明下一个真正的居家“big thing”。当然除非你能让我们都变成流浪汉。</p>
</blockquote>
<h3 id="译者评论"><a href="#译者评论" class="headerlink" title="译者评论"></a>译者评论</h3><p>我认为作者在说别人狭隘的时候，自己也却很狭隘地局限在“自己居家使用”这个使用场景。他没有考虑更多地使用场景，也没有考虑更广泛的人群，例如在印度，例如在非洲，收入不高，但是上网需求强烈。所以我觉得原作者写这篇文章不够是不够严谨的。尽管如此，这篇文章也给我们带来有价值的思考，所以还是拿出来和大家分享。我觉得至少带来以下一些有价值</p>
<h4 id="1-什么是手机？"><a href="#1-什么是手机？" class="headerlink" title="1.什么是手机？"></a>1.什么是手机？</h4><p>我想今天的手机的定义与几年前的肯定不一样了。在几年前，手机的定义是打电话发短信。而今天这只是手机的一小部分。今天以及未来，手机意味着什么？我们如此狂热追逐的究竟是什么？</p>
<h4 id="2-我们到底需要什么？"><a href="#2-我们到底需要什么？" class="headerlink" title="2.我们到底需要什么？"></a>2.我们到底需要什么？</h4><p>由上一个问题，带出这个问题。我们需要的是握在手中的手机本身呢？还是一个更深层，更抽象可以体现我们需要的东西。这个问题可以带我们离开手机本身，而直面用户的本质需求，从而创造出比现在手机更能满足用户需求的产品。</p>
<h4 id="3-手机可以是什么？"><a href="#3-手机可以是什么？" class="headerlink" title="3.手机可以是什么？"></a>3.手机可以是什么？</h4><p>“手机”不是我们手中握着的方块，它是我们需求的载体。如果没有乔布斯，或许我们不会想到手机还可以向今天这样。照样，从用户的根本需求出发，明天“手机”可以是什么？</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mobile/">mobile</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/translation/">translation</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Hugo探究" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/07/Hugo探究/" class="article-date">
  	<time datetime="2016-05-07T08:00:06.000Z" itemprop="datePublished">2016-05-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/07/Hugo探究/">Hugo探究</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>朋友介绍了一个开源项目<a href="https://github.com/JakeWharton/hugo" target="_blank" rel="external">Hugo</a>，国庆期间，我对它进行了一些学习和探究。</p>
<h3 id="Hugo介绍"><a href="#Hugo介绍" class="headerlink" title="Hugo介绍"></a>Hugo介绍</h3><p>我们写代码时，常会打日志输出某个函数执行耗时，传入的参数以及返回值。那么我们能否把这件事情做的更加优雅呢？Hugo就是为此而设计的。<br>你只需要在需要监控的函数上加上@DebugLog注解，函数运行时就会自动输出上面提到的信息。<br>例如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DebugLog</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">(String first, String last)</span> </span>&#123;</span><br><span class="line">  SystemClock.sleep(<span class="number">15</span>); <span class="comment">// Don't ever really do this!</span></span><br><span class="line">  <span class="keyword">return</span> first + <span class="string">" "</span> + last;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出结果：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">V/Example: ⇢ getName(first=<span class="string">"Jake"</span>, last=<span class="string">"Wharton"</span>)</span><br><span class="line">V/Example: ⇠ getName [<span class="number">16</span>ms] = <span class="string">"Jake Wharton"</span></span><br></pre></td></tr></table></figure></p>
<p>log只会在debug版本中输出（这需要写编译插件，目前只支持gradle编译），并且添加的注解也不会被VM读取，所以<strong>可以认为它对release版本没有任何影响</strong>，因此我们也可以放心地把加了注解的代码提交到代码仓库中。</p>
<h3 id="Hugo的实现原理"><a href="#Hugo的实现原理" class="headerlink" title="Hugo的实现原理"></a>Hugo的实现原理</h3><p>要理清Hugo的实现原理，我觉得要回答两个问题：</p>
<ol>
<li>如何只通过加一个注解，就实现输出日志的功能？</li>
<li>如何做到对release版毫无影响？</li>
</ol>
<p>我们通过分析源码来逐个解决问题。</p>
<h4 id="1-如何输出日志？"><a href="#1-如何输出日志？" class="headerlink" title="1.如何输出日志？"></a>1.如何输出日志？</h4><p>核心代码在hugo.weaving.internal.Hugo.java中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hugo</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Pointcut</span>(<span class="string">"within(@hugo.weaving.DebugLog *)"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">withinAnnotatedClass</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Pointcut</span>(<span class="string">"execution(* *(..)) &amp;&amp; withinAnnotatedClass()"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">methodInsideAnnotatedType</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Pointcut</span>(<span class="string">"execution(*.new(..)) &amp;&amp; withinAnnotatedClass()"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">constructorInsideAnnotatedType</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Pointcut</span>(<span class="string">"execution(@hugo.weaving.DebugLog * *(..)) || methodInsideAnnotatedType()"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Pointcut</span>(<span class="string">"execution(@hugo.weaving.DebugLog *.new(..)) || constructorInsideAnnotatedType()"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">constructor</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Around</span>(<span class="string">"method() || constructor()"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">logAndExecute</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="comment">//ProceedingJoinPoint有参数信息，输出参数的值</span></span><br><span class="line">    enterMethod(joinPoint);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> startNanos = System.nanoTime();<span class="comment">//函数执行前记录时间，像我们手动做的一样</span></span><br><span class="line">    </span><br><span class="line">    Object result = joinPoint.proceed();<span class="comment">//这里代表我们监控的函数</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//函数执行结束时，打点记录时间，并计算耗时</span></span><br><span class="line">    <span class="keyword">long</span> stopNanos = System.nanoTime();</span><br><span class="line">    <span class="keyword">long</span> lengthMillis = TimeUnit.NANOSECONDS.toMillis(stopNanos - startNanos);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//输出函数的值，执行耗时</span></span><br><span class="line">    exitMethod(joinPoint, result, lengthMillis);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">enterMethod</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">exitMethod</span><span class="params">(JoinPoint joinPoint, Object result, <span class="keyword">long</span> lengthMillis)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">asTag</span><span class="params">(Class&lt;?&gt; cls)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Hugo.java这个类有一个注解@Aspect。这里用到了<a href="https://eclipse.org/aspectj/" target="_blank" rel="external">AspectJ</a>，AspectJ是基于Java的AOP框架，关于AOP和AspectJ这里有一篇不错的中文<a href="http://www.ibm.com/developerworks/cn/java/j-lo-springaopcglib/" target="_blank" rel="external">介绍</a>。<br>到这里我们可以理解了，借助AspectJ，Hugo在编译期对有@DebugLog注解的函数加上log逻辑。<br>例如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DebugLog</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printArgs</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (String arg : args) &#123;</span><br><span class="line">    Log.i(<span class="string">"Args"</span>, arg);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>编译后，再反编译，看到的结果如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DebugLog</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">printArgs</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">    JoinPoint makeJP = Factory.makeJP(ajc$tjp_0, (Object) <span class="keyword">this</span>, </span><br><span class="line">        (Object) <span class="keyword">this</span>, (Object) args);</span><br><span class="line">    Hugo.aspectOf().logAndExecute(<span class="keyword">new</span> AjcClosure1(<span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>, </span><br><span class="line">        args, makeJP&#125;).linkClosureAndJoinPoint(<span class="number">69648</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">printArgs_aroundBody0</span><span class="params">(HugoActivity ajc$<span class="keyword">this</span>, String[] args, </span><br><span class="line">    JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (String arg : args) &#123;</span><br><span class="line">        Log.i(<span class="string">"Args"</span>, arg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AjcClosure1</span> <span class="keyword">extends</span> <span class="title">AroundClosure</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AjcClosure1</span><span class="params">(Object[] objArr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(objArr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">(Object[] objArr)</span> </span>&#123;</span><br><span class="line">        Object[] objArr2 = <span class="keyword">this</span>.state;</span><br><span class="line">        HugoActivity.printArgs_aroundBody0((HugoActivity) objArr2[<span class="number">0</span>], </span><br><span class="line">            (String[]) objArr2[<span class="number">1</span>], (JoinPoint) objArr2[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>printArgs()函数已经被代理了。</p>
<h4 id="2-如何做到对release版本无影响"><a href="#2-如何做到对release版本无影响" class="headerlink" title="2.如何做到对release版本无影响"></a>2.如何做到对release版本无影响</h4><p>根据文档，使用Hugo时，除了引入aar，还需要在gradle文件中引入Hugo插件。<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">'com.jakewharton.hugo'</span></span><br></pre></td></tr></table></figure></p>
<p>插件的核心代码在hugo.weaving.plugin.HugoPlugin.groovy，核心代码如下：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">project.dependencies &#123;</span><br><span class="line">    debugCompile <span class="string">'com.jakewharton.hugo:hugo-runtime:1.2.2-SNAPSHOT'</span></span><br><span class="line">    debugCompile <span class="string">'org.aspectj:aspectjrt:1.8.6'</span></span><br><span class="line">    compile <span class="string">'com.jakewharton.hugo:hugo-annotations:1.2.2-SNAPSHOT'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里就明白了，因为这里的依赖声明是debugCompile，故release不会输出log。<br>再来看Annotation的声明<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;TYPE, METHOD, CONSTRUCTOR&#125;) <span class="meta">@Retention</span>(CLASS)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DebugLog &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由于注解DebugLog的RetentionPolicy是CLASS，所以它虽然会被写入class文件中，但是不会被VM读取到，对运行时没有影响。（注：项目的README中介绍说“the annotation itself is never present in the compiled class file for any build type”我觉得是不太妥，根据源码，他应该是会存在于编译后的class文件的。）</p>
<h3 id="Hugo的价值"><a href="#Hugo的价值" class="headerlink" title="Hugo的价值"></a>Hugo的价值</h3><p>毫无疑问，Hugo可以用极小的代价帮我们实现优雅的函数监控。当然如果像我们这样使用maven打包的，我们需要自己开发maven的插件。<br>但我觉得Hugo的价值不止于此。Hugo给我们提供一种思路，在Android中，利用AOP的思路实现优雅的变成。我想类似的思想我们还可以做别的很多事情，例如统计打点，例如可以用在我们的common模块中实现模块解耦等等。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AOP/">AOP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 Light Zhang
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>